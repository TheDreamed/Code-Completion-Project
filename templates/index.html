<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monaco Copilot-Style Autocomplete (Inline Provider)</title>

  <!--  ⚠️  Use Monaco >= 0.33 for the inline-completion API  -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

  <style>
    :root { font-family: system-ui, sans-serif; }
    body   { margin: 0; display: flex; flex-direction: column; height: 100vh; }
    #bar   { padding: .5rem 1rem; background: #f0f0f0; border-bottom: 1px solid #ccc;
             display: flex; align-items: center; gap: 1rem; }
    #editor{ flex: 1 1 auto; }
  </style>
</head>

<body>
  <div id="bar">
    <strong>Monaco Copilot Clone (Inline API)</strong>
    <button id="theme-btn">Toggle Theme (Ctrl+J)</button>
  </div>
  <div id="editor"></div>

  <script>
    /* ────────────────────────────────────────────────────────────── *
     * 1.  Bootstrap Monaco
     * ────────────────────────────────────────────────────────────── */
    require.config({
      paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }
    });

    require(['vs/editor/editor.main'], () => {
      const editor = monaco.editor.create(document.getElementById('editor'), {
        value: [
          '# Start typing Python…',
          '',
          'def hello_world():',
          '    print("Hello World!")',
          ''
        ].join('\n'),
        language: 'python',
        automaticLayout: true,
        fontSize: 14,
        minimap: { enabled: false }
      });

      /* ─────────────────────────────────────────────────────────── *
       * 2.  Inline-completion provider  (Copilot-style ghost text)
       * ─────────────────────────────────────────────────────────── */
      monaco.languages.registerInlineCompletionsProvider('python', {
        async provideInlineCompletions(model, position, context, token) {
          /* Grab code up to the caret */
          const prefix = model.getValueInRange({
            startLineNumber: 1, startColumn: 1,
            endLineNumber  : position.lineNumber,
            endColumn      : position.column
          });

          /* Call your backend LLM endpoint */
          let suggestionText = '';
          try {
            const res = await fetch('/autocomplete', {
              method : 'POST',
              headers: { 'Content-Type': 'application/json' },
              body   : JSON.stringify({ snippet: prefix })
            });
            const { suggestion = '' } = await res.json();
            suggestionText = suggestion.replace(/^[\s\n]+/, '');
          } catch (err) {
            console.error('autocomplete error', err);
          }

          if (!suggestionText || token.isCancellationRequested) {
            return { items: [], dispose() {} };
          }

          /* Monaco shows this faded; Tab / → accept, Esc dismiss */
          return {
            items: [{
              insertText: suggestionText,
              range: new monaco.Range(position.lineNumber, position.column,
                                      position.lineNumber, position.column),
              command: { id: 'acceptInlineSuggestion' }      // built-in
            }],
            dispose() {}
          };
        },
        handleItemDidShow() {},
        freeInlineCompletions() {}   // required empty stub
      });

      /* ─────────────────────────────────────────────────────────── *
       * 3.  Optional extras
       * ─────────────────────────────────────────────────────────── */
      /* Theme toggle */
      function toggleTheme() {
        const current = editor._themeService._theme.themeName;
        monaco.editor.setTheme(current === 'vs-dark' ? 'vs' : 'vs-dark');
      }
      document.getElementById('theme-btn').onclick = toggleTheme;
      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyJ, toggleTheme);
    });
  </script>
</body>
</html>
